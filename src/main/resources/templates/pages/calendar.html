<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Í∞êÏ†ï ÌÜµÍ≥Ñ Îã¨Î†•</title>
    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <link rel="stylesheet" th:href="@{/css/phone-style.css}" />
    <link rel="stylesheet" th:href="@{/css/phone-frame.css}" />
    <link rel="stylesheet" th:href="@{/css/scrollbar-style.css}" />
    <link rel="stylesheet" th:href="@{/css/app-content.css}" />
    <style>
        body {
            font-family: 'S-CoreDream', sans-serif;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 140px;
        }

        .chart-container {
            background: white;
            margin: 20px 16px;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .chart-container h3 {
            text-align: center;
            color: #007BFF;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 0 18px 16px;
        }

        .toggle-buttons button {
            padding: 8px 16px;
            font-size: 14px;
            font-family: 'GmarketSans', sans-serif;
            border-radius: 20px;
            border: 1px solid var(--primary-color);
            background-color: white;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-buttons button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #yearlyGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto 20px auto;
        }

        /* Ïó∞Í∞Ñ ÌûàÌä∏Îßµ ÏÖÄÏùò ÌÅ¨Í∏∞Î•º Î™ÖÌôïÌûà ÏßÄÏ†ï */
        .heat-cell {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 4px;
            background-color: #f0f4ff;
            opacity: 0.6;
            transition: transform 0.2s ease, filter 0.2s ease;
            cursor: pointer;
            overflow: hidden; /* Ï∂îÍ∞Ä: Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÖÄ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÏßÄ ÏïäÎèÑÎ°ù */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Ïù¥Î™®ÏßÄÍ∞Ä ÏûàÎäî Ïπ∏ */
        .heat-cell:has(img) {
            background-color: #e0e6ff;
            opacity: 1;
        }

        /* Ìò∏Î≤Ñ Ïãú Ìö®Í≥º */
        .heat-cell:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
            z-index: 1;
        }

        /* Í∏∞Ï°¥Ïùò Ï§ëÎ≥µÎêòÎäî emotion-img Í∑úÏπôÏùÑ ÌïòÎÇòÎ°ú ÌÜµÌï© */
        .emotion-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
            max-width: 100%;
            max-height: 100%;
            display: block; /* Ï∂îÍ∞Ä: Ïù¥ÎØ∏ÏßÄ ÌïòÎã® Ïó¨Î∞± Ï†úÍ±∞ */
        }

        /* ÏõîÍ∞Ñ Îã¨Î†• */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        /* ÏõîÍ∞Ñ Îã¨Î†• Í∞êÏ†ï ÏïÑÏù¥ÏΩò Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ Í≥†Ï†ï */
        .calendar-cell .emotion {
            width: 24px;
            height: 24px;
            margin-top: 4px;
            transition: transform 0.2s ease;
            overflow: hidden; /* Ï∂îÍ∞Ä */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-header button {
            background: linear-gradient(135deg, #007BFF, #00a1ff);
            color: white;
            border: none;
            font-size: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .calendar-header button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }

        #monthTitle {
            font-size: 17px;
            color: #007BFF;
            font-weight: bold;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .weekday-header {
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            color: #007BFF;
            padding-bottom: 4px;
            border-bottom: 1px solid #e0e6ff;
        }

        .calendar-cell {
            background-color: #f9fbff;
            border-radius: 14px;
            text-align: center;
            padding: 6px 4px;
            font-size: 11px;
            min-height: 46px;
            box-shadow: inset 0 0 0 1px #e0e6ff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .calendar-cell:hover {
            background-color: #eef4ff;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.1);
        }

        .calendar-cell:hover .emotion {
            transform: scale(1.15);
        }

        .yearly-label {
            text-align: center;
            font-size: 10px;
            color: #999;
        }

        .emotion-filters {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e6ff;
        }

        .emotion-filters h4 {
            text-align: center;
            font-size: 14px;
            color: #007BFF;
            margin-bottom: 12px;
        }

        .emotion-counters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .emotion-counter {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            background: #f3f4f7;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .emotion-counter.active {
            border-color: #007BFF;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .emotion-counter .emotion-icon {
            margin-right: 6px;
            font-size: 16px;
        }

        .emotion-counter .emotion-name {
            margin-right: 4px;
        }

        .emotion-counter .emotion-count {
            background: rgba(0, 123, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ÌïÑÌÑ∞ÎßÅÎêú ÏÖÄ Ïä§ÌÉÄÏùº */
        .heat-cell.filtered {
            opacity: 0.2;
        }

        .heat-cell[data-emotion="ÌñâÎ≥µ"] { background-color: #FFF9C4; }
        .heat-cell[data-emotion="ÎßåÏ°±"] { background-color: #FFE0B2; }
        .heat-cell[data-emotion="ÏÑ§Î†ò"] { background-color: #F8BBD0; }
        .heat-cell[data-emotion="ÌèâÏò®"] { background-color: #B2DFDB; }
        .heat-cell[data-emotion="Î∂àÏïà"] { background-color: #CFD8DC; }
        .heat-cell[data-emotion="Ïä¨Ìîî"] { background-color: #90A4AE; }
        .heat-cell[data-emotion="Î∂ÑÎÖ∏"] { background-color: #FFAB91; }

        .menu-bar, .new-diary-button {
            position: absolute;
            z-index: 10;
        }

        .menu-bar {
            bottom: 70px;
            left: 0;
            right: 0;
            height: 65px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.06);
            border-top: 1px solid #f0f0f0;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 11px;
            font-weight: 500;
        }

        .menu-item.active {
            color: #007BFF;
        }

        .menu-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .new-diary-button {
            bottom: 140px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #007BFF, #00a1ff);
            color: white;
            font-size: 24px;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }

        .new-diary-button:active {
            transform: scale(0.92);
        }

        #tooltip {
            display: none;
            position: fixed; /* ‚Üê positionÏùÑ absolute ‚Üí fixed Î°ú Î≥ÄÍ≤Ω */
            background: white;
            border: 1px solid #ccc;
            padding: 6px 10px;
            font-size: 13px;
            color: black;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 99999;
            pointer-events: none;
        }

        /*Î™®Îã¨Ï∞Ω*/
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: fadeIn 0.3s ease;
            border: none;
            outline: none;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
        }

        .modal-header button {
            background: #f5f5f5;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-header button:hover {
            background: #e0e0e0;
        }

        .modal-tags {
            margin-bottom: 16px;
        }

        .modal-tags span {
            display: inline-block;
            margin: 4px 8px 4px 0;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            background: linear-gradient(135deg, #007BFF, #00a1ff);
            color: white;
            font-weight: 500;
        }

        .modal-text {
            margin: 16px 0;
            font-size: 15px;
            line-height: 1.6;
            color: #444;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #007BFF;
        }

        .modal-audio {
            margin: 16px 0;
        }

        .modal-audio audio {
            width: 100%;
            height: 40px;
            border-radius: 8px;
        }

        .modal-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-images img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .modal-images img:hover {
            transform: scale(1.05);
        }

        .heatmap-vertical {
            display: flex;
        }

        .heatmap-row {
            margin-bottom: 2px;
        }

        .day-label {
            width: 24px;
            font-size: 10px;
            text-align: right;
            margin-right: 4px;
        }

        .week-column {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div class="frame-container"><div class="phone-frame"></div></div>
<div class="phone-container">
    <div class="notch"></div>
    <div class="status-bar">
        <div class="time">9:41</div>
        <div class="status-icons">
            <div class="signal"><div></div><div></div><div></div><div></div></div>
        </div>
    </div>
    <div class="app-container">
        <div class="app-header header-layout-center">
            <div class="app-title">Í∞êÎã§ ÏùºÍ∏∞</div>
            <div class="app-date">ÎÇòÏùò Í∞êÏ†ï Î™®ÏïÑÎ≥¥Í∏∞</div>
        </div>
        <div class="scrollable-content">
            <div class="toggle-buttons">
                <form method="get" th:action="@{/calendar}">
                    <input type="hidden" name="mode" value="monthly"/>
                    <button type="submit" th:classappend="${mode} == 'monthly' ? 'active'">ÏõîÍ∞Ñ</button>
                </form>
                <form method="get" th:action="@{/calendar}">
                    <input type="hidden" name="mode" value="yearly"/>
                    <button type="submit" th:classappend="${mode} == 'yearly' ? 'active'">Ïó∞Í∞Ñ</button>
                </form>
            </div>

            <!-- ÏõîÍ∞Ñ Îã¨Î†• -->
            <div id="calendar-view" class="chart-container" th:if="${mode} == 'monthly'">
                <div class="calendar-header">
                    <button id="prevMonthBtn">‚Üê</button>
                    <h3 id="monthTitle" th:text="${year} + 'ÎÖÑ ' + ${month} + 'Ïõî'"></h3>
                    <button id="nextMonthBtn">‚Üí</button>
                </div>

                <div class="calendar-grid">
                    <!-- ÏöîÏùº Ìó§Îçî -->
                    <div class="weekday-header">Ïùº</div>
                    <div class="weekday-header">Ïõî</div>
                    <div class="weekday-header">Ìôî</div>
                    <div class="weekday-header">Ïàò</div>
                    <div class="weekday-header">Î™©</div>
                    <div class="weekday-header">Í∏à</div>
                    <div class="weekday-header">ÌÜ†</div>

                    <!-- Îπà ÏÖÄ: Ìï¥Îãπ ÏõîÏùò ÏãúÏûë ÏöîÏùº Î≥¥Ï†ï -->
                    <th:block th:each="i : ${#numbers.sequence(1, firstDayOfWeek)}">
                        <div class="calendar-cell"></div>
                    </th:block>

                    <!-- ÎÇ†Ïßú ÏÖÄ -->
                    <th:block th:each="day : ${#numbers.sequence(1, lastDay)}"
                              th:with="dayStr=${day < 10 ? '0' + day : day},
                   monthStr=${month < 10 ? '0' + month : month},
                   key=${year + '-' + monthStr + '-' + dayStr}">
                        <div class="calendar-cell"
                             th:data-date="${key}"
                             th:data-diary-id="${diaryIdMap[key.toString()]}"
                             th:onclick="${diaryIdMap[key.toString()] != null} ? 'openDiaryModal(' + diaryIdMap[key.toString()] + ')' : null">
                            <div th:text="${day}"></div>
                            <th:block th:if="${emotionMap[key.toString()] != null}">
                                <div class="emotion" th:onclick="${diaryIdMap[key.toString()] != null} ? 'openDiaryModal(' + diaryIdMap[key.toString()] + ')' : null">
                                    <img class="emotion-img"
                                         th:src="@{'/images/emotions/' + ${emotionMap[key.toString()]}}"
                                         alt="Í∞êÏ†ï" />
                                </div>
                            </th:block>
                        </div>
                    </th:block>

                </div>
            </div>


            <!-- Ïó∞Í∞Ñ ÌûàÌä∏Îßµ -->
            <div id="yearly-view" class="chart-container" th:if="${mode} == 'yearly'">
                <div class="calendar-header">
                    <button id="prevYearBtn">‚Üê</button>
                    <h3 id="yearTitle" th:text="${year} + 'ÎÖÑ Í∞êÏ†ï'" th:attr="data-year=${year}"></h3>

                    <button id="nextYearBtn">‚Üí</button>
                </div>



                <div id="yearlyGrid" class="heatmap-vertical">
                    <div></div>
                    <th:block th:each="m : ${#numbers.sequence(1,12)}">
                        <div class="yearly-label" th:text="${m} + 'Ïõî'"></div>
                    </th:block>
                    <th:block th:each="d : ${#numbers.sequence(1,31)}">
                        <div class="day-label" th:text="${d}"></div>
                        <th:block th:each="m : ${#numbers.sequence(1,12)}">
                            <th:block th:with="key=${year + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d)}">
                                <div class="heat-cell" th:if="${yearlyEmotionMap[key] != null}" th:data-emotion="${yearlyEmotionMap[key]}"></div>
                            </th:block>
                        </th:block>
                    </th:block>
                </div>

                <!-- Í∞êÏ†ï ÌïÑÌÑ∞Ïö© Ïπ¥Ïö¥ÌÑ∞ ÏòÅÏó≠ -->
                <div class="emotion-filters">
                    <h4>Í∞êÏ†ïÎ≥Ñ Î∂ÑÌè¨</h4>
                    <div id="emotionCounters" class="emotion-counters"></div>
                </div>
            </div>
            <div id="tooltip"></div>

        </div>

        <!-- Î™®Îã¨ -->
        <div id="diaryModal" class="modal-backdrop" style="display: none;">
            <div class="modal-box">
                <div class="modal-header">
                    <span id="modalTitle" class="modal-title">Ï†úÎ™©</span>
                    <button id="closeModal">‚úï</button>
                </div>
                <div class="modal-tags" id="modalTags"></div>
                <div id="modalContent" class="modal-text"></div>
                <div id="modalAudio" class="modal-audio"></div>
                <div id="modalImages" class="modal-images"></div>
            </div>
        </div>


        <!-- Î©îÎâ¥ Î∞î Î∞è ÏÉà ÏùºÍ∏∞ Î≤ÑÌäº -->
        <button class="new-diary-button">+</button>
        <!-- Î©îÎâ¥ Î∞î -->
        <div class="menu-bar">

            <div class="menu-item">
                <div class="menu-icon">üí¨</div>
                <div>Ï±ÑÌåÖ</div>
            </div>
            <div class="menu-item" onclick="location.href='/calendar'">
                <div class="menu-icon">üìÖ</div>
                <div>Îã¨Î†•</div>
            </div>
            <div class="menu-item active">
                <div class="menu-icon">üìñ</div>
                <div>ÏùºÍ∏∞</div>
            </div>
            <div class="menu-item" onclick="location.href='/chart'">
                <div class="menu-icon">üìä</div>
                <div>ÌÜµÍ≥Ñ</div>
            </div>
            <div class="menu-item active">
                <div class="menu-icon">‚öôÔ∏è</div>
                <div>ÏÑ§Ï†ï</div>
            </div>
        </div>
    </div>
</div>

<script>

    // yearly-heatmap.js

    function getWeekAndDay(dateStr) {
        const date = new Date(dateStr);
        const startOfYear = new Date(date.getFullYear(), 0, 1);
        const dayOfWeek = date.getDay();
        const week = Math.floor(((date - startOfYear) / (1000 * 60 * 60 * 24) + startOfYear.getDay()) / 7);
        return { week, day: dayOfWeek };
    }

    function getWeekNumber(date) {
        const jan1 = new Date(date.getFullYear(), 0, 1);
        const dayOfYear = ((date - jan1) / 86400000) + jan1.getDay() + 1;
        return Math.ceil(dayOfYear / 7);
    }

    function loadYearlyHeatmap(year) {
        fetch(`/api/calendar/yearly/${year}`)
            .then(res => res.json())
            .then(data => {
                updateEmotionCounters(data);

                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÎÖÑÎèÑ Ï∂îÏ∂ú
                const actualYear = Object.keys(data).length > 0 ?
                    Object.keys(data)[0].split('-')[0] : year;

                // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
                const yearTitle = document.getElementById("yearTitle");
                if (yearTitle) {
                    yearTitle.innerText = actualYear + 'ÎÖÑ Í∞êÏ†ï ÌûàÌä∏Îßµ';
                    yearTitle.setAttribute('data-year', actualYear);
                }

                renderHeatmap(data, actualYear);
            });
    }

    // renderHeatmap Ìï®Ïàò ÏàòÏ†ï
    function renderHeatmap(emotionMap, year) {
        const grid = document.getElementById("yearlyGrid");
        grid.innerHTML = "";

        const start = new Date(`${year}-01-01`);
        const end = new Date(`${year}-12-31`);
        const cells = [];

        // 1ÎÖÑÍ∞ÑÏùò Î™®Îì† ÎÇ†ÏßúÎ•º ÏàúÏÑúÎåÄÎ°ú Î∞∞Ïó¥Ïóê Ï†ÄÏû•
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().slice(0, 10);
            const raw = emotionMap[dateStr];
            const emoji = typeof raw === "string" ? raw : raw?.emoji || null;
            const diaryId = typeof raw === "object" ? raw?.diaryId : null;

            cells.push({ date: dateStr, emoji, diaryId });
        }

        // 7Ïπ∏Ïî© ÎÇòÎàÑÏñ¥ÏÑú Ìñâ ÏÉùÏÑ± (ÍπÉÌóàÎ∏å ÏûîÎîî ÏÑ∏Î°ú Î≤ÑÏ†Ñ)
        const totalRows = Math.ceil(cells.length / 7);

        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(7, 1fr)";
        grid.style.gridTemplateRows = `repeat(${totalRows}, auto)`;

        // Î™®Îì† ÎÇ†ÏßúÎ•º ÏàúÏÑúÎåÄÎ°ú Î†åÎçîÎßÅ
        cells.forEach((cellData, index) => {
            const cell = document.createElement("div");
            cell.className = "heat-cell";

            if (cellData.emoji) {
                const img = document.createElement("img");
                img.src = `/images/emotions/${extractFileName(cellData.emoji)}`;
                img.className = "emotion-img";
                img.style.width = "100%";
                img.style.height = "100%";

                if (cellData.diaryId) {
                    cell.style.cursor = "pointer";
                    cell.addEventListener("click", (e) => {
                        e.stopPropagation();
                        openDiaryModal(cellData.diaryId);
                    });
                }
                cell.appendChild(img);
            }

            // Ìà¥ÌåÅ Ïù¥Î≤§Ìä∏ (ÏùºÍ∏∞Í∞Ä ÏûàÎì† ÏóÜÎì† ÎÇ†Ïßú ÌëúÏãú)
            cell.addEventListener("mouseenter", (e) => {
                const tooltip = document.getElementById("tooltip");
                tooltip.innerText = cellData.date;
                tooltip.style.display = "block";
                tooltip.style.position = "fixed";
                tooltip.style.left = e.clientX + 10 + "px";
                tooltip.style.top = e.clientY - 30 + "px";
                tooltip.style.background = "white";
                tooltip.style.border = "1px solid #ccc";
                tooltip.style.padding = "6px 10px";
                tooltip.style.fontSize = "13px";
                tooltip.style.color = "black";
                tooltip.style.borderRadius = "6px";
                tooltip.style.boxShadow = "0 2px 8px rgba(0,0,0,0.15)";
                tooltip.style.zIndex = "99999";
                tooltip.style.pointerEvents = "none";
            });

            cell.addEventListener("mouseleave", () => {
                const tooltip = document.getElementById("tooltip");
                tooltip.style.display = "none";
            });

            cell.addEventListener("mousemove", (e) => {
                const tooltip = document.getElementById("tooltip");
                tooltip.style.left = e.clientX + 10 + "px";
                tooltip.style.top = e.clientY - 30 + "px";
            });

            grid.appendChild(cell);
        });
    }







    function updateEmotionCounters(emotionMap) {
        const grid = document.getElementById("yearlyGrid");
        const parent = grid?.parentElement;
        const existingFilter = document.querySelector(".emotion-filters");
        if (existingFilter) existingFilter.remove();

        const counterWrapper = document.createElement("div");
        counterWrapper.className = "emotion-filters";
        counterWrapper.innerHTML = `
    <h4>Í∞êÏ†ïÎ≥Ñ Î∂ÑÌè¨</h4>
    <div id="emotionCounters" class="emotion-counters"></div>
  `;

        if (parent) {
            parent.insertBefore(counterWrapper, grid);
        }

        const counterContainer = counterWrapper.querySelector("#emotionCounters");
        if (!counterContainer) return;

        const emotionCounts = {};
        Object.values(emotionMap).forEach(entry => {
            const emoji = typeof entry === 'string' ? entry : entry?.emoji;
            if (emoji) {
                const fileName = extractFileName(emoji);
                if (!emotionCounts[fileName]) emotionCounts[fileName] = 0;
                emotionCounts[fileName]++;
            }
        });

        const allBtn = document.createElement('div');
        allBtn.className = 'emotion-counter active';
        allBtn.innerText = 'Ï†ÑÏ≤¥';
        allBtn.addEventListener('click', () => {
            document.querySelectorAll('.heat-cell').forEach(cell => cell.classList.remove('filtered'));
            document.querySelectorAll('.emotion-counter').forEach(c => c.classList.remove('active'));
            allBtn.classList.add('active');
        });
        counterContainer.appendChild(allBtn);

        const emotionNameMap = {
            "happy.png": "ÌñâÎ≥µ",
            "satisfied.png": "ÎßåÏ°±",
            "excited.png": "ÏÑ§Î†ò",
            "peaceful.png": "ÌèâÏò®",
            "anxious.png": "Î∂àÏïà",
            "sad.png": "Ïä¨Ìîî",
            "angry.png": "Î∂ÑÎÖ∏"
        };

        Object.entries(emotionCounts).forEach(([fileName, count]) => {
            const counter = document.createElement("div");
            counter.className = "emotion-counter";
            const emotionName = emotionNameMap[fileName] || "Ïïå Ïàò ÏóÜÏùå";

            counter.innerHTML = `<img src="/images/emotions/${fileName}" alt="emotion" style="width:18px; height:18px; margin-right:6px; border-radius:4px;"><span>${emotionName}(${count})</span>`;
            counter.addEventListener("click", () => filterByEmotion(fileName));
            counterContainer.appendChild(counter);
        });
    }

    function filterByEmotion(fileName) {
        document.querySelectorAll('.heat-cell').forEach(cell => {
            const img = cell.querySelector('img');
            if (!img || !img.src.includes(fileName)) {
                cell.classList.add('filtered');
            } else {
                cell.classList.remove('filtered');
            }
        });

        document.querySelectorAll('.emotion-counter').forEach(c => c.classList.remove('active'));
        const selected = [...document.querySelectorAll('.emotion-counter')].find(c => c.innerHTML.includes(fileName));
        if (selected) selected.classList.add('active');
    }

    function extractFileName(path) {
        return path.substring(path.lastIndexOf('/') + 1);
    }

    function openDiaryModal(diaryId) {
        if (!diaryId) return;

        console.log("Opening modal for diary ID:", diaryId); // ÎîîÎ≤ÑÍπÖÏö©

        fetch(`/api/diary/${diaryId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to fetch diary");
                return res.json();
            })
            .then(data => {
                console.log("Diary data:", data); // ÎîîÎ≤ÑÍπÖÏö©

                document.getElementById('modalTitle').innerText = data.title || 'Ï†úÎ™© ÏóÜÏùå';
                document.getElementById('modalContent').innerText = data.content || 'ÎÇ¥Ïö© ÏóÜÏùå';

                const tagBox = document.getElementById('modalTags');
                tagBox.innerHTML = '';
                (data.tags || []).forEach(tag => {
                    const span = document.createElement('span');
                    span.innerText = tag;
                    tagBox.appendChild(span);
                });

                const imgBox = document.getElementById('modalImages');
                imgBox.innerHTML = '';
                (data.photos || []).forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    imgBox.appendChild(img);
                });

                const audioBox = document.getElementById('modalAudio');
                audioBox.innerHTML = '';
                if (data.audioUrl) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = data.audioUrl;
                    audioBox.appendChild(audio);
                }

                document.getElementById('diaryModal').style.display = 'flex';
            })
            .catch(err => {
                console.error("Modal fetch error:", err);
                alert("ÏùºÍ∏∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            });
    }

    // Î™®Îã¨ Îã´Í∏∞ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
    function closeModal() {
        document.getElementById('diaryModal').style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
        const closeModalBtn = document.getElementById('closeModal');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeModal);
        }

        // Î™®Îã¨ Î∞∞Í≤Ω ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        const modalBackdrop = document.getElementById('diaryModal');
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', function(e) {
                if (e.target === modalBackdrop) {
                    closeModal();
                }
            });
        }

        // ÏõîÍ∞Ñ Îã¨Î†•ÏóêÏÑú emotion divÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
        document.querySelectorAll('.calendar-cell .emotion').forEach(emotionDiv => {
            const parentCell = emotionDiv.closest('.calendar-cell');
            const diaryId = parentCell?.getAttribute('data-diary-id');
            if (diaryId) {
                emotionDiv.style.cursor = 'pointer';
                emotionDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openDiaryModal(parseInt(diaryId));
                });
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'monthly';
        if (mode === 'yearly') {
            const year = urlParams.get('year') || 2025;
            loadYearlyHeatmap(year);
        }

        const prevMonthBtn = document.getElementById("prevMonthBtn");
        const nextMonthBtn = document.getElementById("nextMonthBtn");

        if (prevMonthBtn) {
            prevMonthBtn.addEventListener("click", function () {
                changeMonth(-1);
            });
        }

        if (nextMonthBtn) {
            nextMonthBtn.addEventListener("click", function () {
                changeMonth(1);
            });
        }
        // Ïó∞Í∞Ñ Îã¨Î†• ÌôîÏÇ¥Ìëú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
        const prevYearBtn = document.getElementById("prevYearBtn");
        const nextYearBtn = document.getElementById("nextYearBtn");

        if (prevYearBtn) {
            prevYearBtn.addEventListener("click", function () {
                changeYear(-1);
            });
        }

        if (nextYearBtn) {
            nextYearBtn.addEventListener("click", function () {
                changeYear(1);
            });
        }


        function changeYear(offset) {
            const yearTitle = document.getElementById("yearTitle");
            const currentYear = parseInt(yearTitle.dataset.year);
            const newYear = currentYear + offset;

            // Í∞êÏ†ï ÌÜµÍ≥Ñ ÏÉÅÎã® Ïó∞ÎèÑÎèÑ Í∞±Ïã†
            const appDateElement = document.querySelector('.app-date');
            if (appDateElement) {
                appDateElement.innerText = newYear + 'ÎÖÑ';
            }

            location.href = `/calendar?mode=yearly&year=${newYear}`;
        }

    });


    function changeMonth(offset) {
        const currentYear = parseInt(document.getElementById("monthTitle").innerText.split('ÎÖÑ')[0]);
        const currentMonth = parseInt(document.getElementById("monthTitle").innerText.split('ÎÖÑ ')[1].replace('Ïõî', ''));

        let newMonth = currentMonth + offset;
        let newYear = currentYear;

        if (newMonth < 1) {
            newMonth = 12;
            newYear -= 1;
        } else if (newMonth > 12) {
            newMonth = 1;
            newYear += 1;
        }

        const yearMonthStr = `${newYear}-${newMonth < 10 ? '0' + newMonth : newMonth}`;
        location.href = `/calendar?mode=monthly&yearMonth=${yearMonthStr}`;
    }

</script>
</body>
</html>